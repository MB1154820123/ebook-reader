<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>《算法导论 第2版》</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="https://www.jq22.com/jquery/font-awesome.4.6.0.css">
    <link rel="stylesheet" href="../static/css/notesStyle.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/prism/9000.0.1/prism.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/prism-themes/1.9.0/prism-a11y-dark.min.css" rel="stylesheet">
    <!--样式二：<link rel="stylesheet" href="../static/css/prism-dark.css">-->
    <link rel="stylesheet" href="../static/css/sweetalert.css">
    <script src="../static/js/sweetalert-dev.js"></script>
    <script src="../static/js/utils/string_util.js"></script>
    <!--右键菜单-->
    <style>
    textarea{
        border:0;
        border-radius:5px;
        background-color:rgba(241,241,241,.98);
        width: 355px;
        height: 100px;
        padding: 10px;
        resize: none;
    }
    .bu{
        width:80%;
        padding-left:10%;
        padding-right:10%;
    }
    [class^=tool]{
        -webkit-user-select: none;
        padding-left:5px;
        line-height: 40px;
        font-family: "Microsoft YaHei UI";
        font-size: 30px;
        font-weight: bold;
        position:absolute;
        width:35px;
        height:40px;
        display:flex;
    }
    [class$=side]{
        background: wheat;
    }
    [class$=face]{
        color:white;
    }
    div.tool-red-side{
        color:red;
        border:2px solid red;
        border-radius: 5px;
    }
    div.tool-blue-side{
        color:blue;
        border:2px solid blue;
        border-radius: 5px;
    }
    div.tool-green-side{
        border:2px solid green;
        color:green;
        border-radius: 5px;
    }
    div.tool-skyblue-face{
        border:2px solid blue;
        background: skyblue;
        border-radius: 5px;
    }
    div.tool-yellowgreen-face{
        border:2px solid indianred;
        background: yellowgreen;
        border-radius: 5px;
    }
    div.tool-purple-face{
        border:2px solid green;
        background: purple;
        border-radius: 5px;
    }
    div.tool-clear{
        border:2px solid darkred;
        color:white;
        background: indianred;
        border-radius: 5px;
    }
    b,mark,span{cursor: pointer;}
    p>span { border-bottom: 2px dotted;color: #E37274;}
    mark{color:antiquewhite}
    /*RCM*/
    body{
        position: absolute;
        top: 0px;
        bottom: 0px;
        right: 0px;
        left: 0px;
        overflow: hidden;
        font-family: "microsoft yahei";
    }

    .RCM-Main{
        position: absolute;
    }
    .RCM-container{
        border: 1px solid #ccc;
        padding: 5px 0px;
        display: block;
        box-shadow: 0px 0px 2px #ccc;
        font-size: 14px;
        border-radius: 3px;
        z-index: 10000;
        background: #fff;
        color: #000;
    }
    .RCM-container ul{
        list-style: none;
        padding: 0px;
        margin: 0px;
    }

    .RCM-container ul li{
        /* width: 70px; */
        height: 30px;
        line-height: 30px;
        /* text-align: center; */
        padding:0px 18px 0px 15px;
        cursor: pointer;
        position: relative;
    }

    .RCM-container ul li:hover{
        background-color: rgba(52, 58, 64, 1.0);
        color: #fff;
    }
    /*.textcenter{*/
    /*    text-align: center;*/
    /*}*/

    .fa-align-right{
        position: absolute;
        right: 0px;
        top: 10px;
    }
    .RCM-child{
        position: absolute;
        top: 0px;
        width: 100%;
    }
    .code_stl_trigger{
        border-radius: 5px;
        background: #9f9f9f;
        color:white;
        user-select:none;
        float:right;
        font-size:14px;
        font-family: "Yang";
    }
    .code_stl_trigger:hover{
        border-radius: 5px;
        background: #eeeeee;
        color:grey;
    }
    </style>
</head>
<!--
Range对象使用心得：
1. range.setStart|End(node,offset) 中的node是range截取范围的容器（可以是元素，也可以是范围更大的节点）
   若该容器中有可见元素，则偏移offset代表【选中】从左向右【几个元素|节点】，若node内部除了文本外不存在可见内容
   则，offset指的是从左往右选中多少个字符(如果Start、End指向同一个元素)；除了这之外，也可以跨多个容器，即
   （Start、End指向不同的容器）
-->
<body>
<!--左侧工具栏-->
<div class="tool-red-side" title="动词" onclick="addNoteId(null,'b','red',2)" style="left:calc(10% - 100px);top:110px;">动</div>
<div class="tool-blue-side" title="名词" onclick="addNoteId(null,'b','blue',2)" style="left:calc(10% - 100px);top:170px;">名</div>
<div class="tool-green-side" title="修词" onclick="addNoteId(null,'b','green',2)" style="left:calc(10% - 100px);top:230px;">修</div>
<div class="tool-skyblue-face" title="主语" onclick="addNoteId(null,'mark','skyblue',2)" style="left:calc(10% - 100px);top:290px;">主</div>
<div class="tool-yellowgreen-face" title="谓语" onclick="addNoteId(null,'mark','yellowgreen',2)" style="left:calc(10% - 100px);top:350px;">谓</div>
<div class="tool-purple-face" title="宾语" onclick="addNoteId(null,'mark','purple',2)" style="left:calc(10% - 100px);top:410px;">宾</div>
<div class="tool-clear" title="清除" onclick="clearNote()" style="left:calc(10% - 100px);top:470px;">清</div>
<div class="bu">
    <h1 class="bu_title">第一部 基础知识</h1>
    <h2 class="zhang_title">第1章 算法在计算中的作用</h2>
    <div class="duan">
        <p class="hang">算法是什么？</p>
        <p class="hang">为什么要研究算法？</p>
        <p class="hang">算法的作用是什么？</p>
    </div>
    <h3 class="jie_title">1.1 算法</h3>
    <div class="duan">
        <p class="hang">算法是定义良好的计算过程，它取一个或一组值作为输入，并产生出一个或一组值作为输出。</p>
        <p class="hang">算法是一系列的计算步骤，将输入数据转换成输出结果。</p>
    </div>
<!--    <button t="1" id="codeStyleBtn">样式切换</button>-->
    <pre><span t="1" id="codeStyleBtn" class="code_stl_trigger">切换主题</span><code class="language-javascript line-numbers">let a = 12;
@media (min-width: 64rem) {
html { font-size: 120%; }
}</code></pre>

</div>
<script type="text/javascript">
    // 代码样式
    $("#codeStyleBtn").click(function (){
        if( $(this).attr("t") == 1 ){
            document.head.innerHTML=document.head.innerHTML.replace("<!--样式二：<link rel=\"stylesheet\" href=\"../static/css/prism-dark.css\">-->","<link rel=\"stylesheet\" href=\"../static/css/prism-dark.css\">");
            $(this).attr("t",2)
        } else if( $(this).attr("t") == 2 ) {
            document.head.innerHTML=document.head.innerHTML.replace("<link rel=\"stylesheet\" href=\"../static/css/prism-dark.css\">","<!--样式二：<link rel=\"stylesheet\" href=\"../static/css/prism-dark.css\">-->");
            $(this).attr("t",1)
        }

    })
    // 永不消逝的全局变量
    let noteID;
    let selectionText;
    function generateNoteId(selection,tag,color){
        if ( undefined == selection || null == selection ){
            selection = window.getSelection();
        }
        let hang = selection.focusNode.parentElement;
        let range = selection.getRangeAt(0);
        let left = selection.anchorOffset;
        let right = selection.focusOffset;
        if ( left == right ) {
            return false;
        }
        let max;
        if ( left > right ) {
            max = left;
            left = right;
            right = max;
        }
        let b1 = (range.startContainer.previousSibling == null);
        let b2 = (range.startContainer.nextSibling == null);
        let hangOuter = hang.outerHTML.replace("<p class=\"hang\">","").replace("</p>","");
        if ( !hangOuter.includes("</b>") && !hangOuter.includes("</mark>") && !hangOuter.includes("</span>") ) {
            // 表示当前行中没有笔记，既然这样，接下来添加的笔记是第一个，id是无争议的
            // 没有笔记正常流程，不用改动left、right
        } else if ( !b1 && b2 ) {
            let nextId = range.startContainer.previousSibling.id;
            let offR = parseInt(nextId.split("-")[2].split(":")[1]);
            right = right + offR;
            left = right - selection.toString().length;
        } else if ( !b1 ) { // 前无元素后有元素、前后都有元素、前后都无元素
            let preId = range.startContainer.previousSibling.id;
            let offR = parseInt(preId.split("-")[2].split(":")[1]);
            right = right + offR;
            left = right - selection.toString().length;
        }
        let did;
        let hid;
        let duan = selection.focusNode.parentElement.parentElement;
        let duans = document.getElementsByClassName("duan");
        for (let i = 0; i < duans.length; i++) {
            if (duans[i] === duan) {
                did = i;
                let hangs = duans[i].children;
                for (let j = 0; j < hangs.length; j++) {
                    if (hangs[j] === hang) {
                        hid = j;
                    }
                }
            }
        }
        let noteId = did + "-" + hid + "-" + left + ":" + right + "-" + tag + "-" + color;
        return noteId
    }


    // 添加noteID
    function addNoteId(selection,tag,color,type) {
        if ( undefined == selection || null == selection){
            selection = window.getSelection();
        }
        let noteId = generateNoteId(selection,tag,color)
        let range = selection.getRangeAt(0);
        /**
        let hang = selection.focusNode.parentElement;
        let range = selection.getRangeAt(0);
        let left = selection.anchorOffset;
        let right = selection.focusOffset;
        if ( left == right ) {
            return false;
        }
        let max;
        if ( left > right ) {
            max = left;
            left = right;
            right = max;
        }
        let b1 = (range.startContainer.previousSibling == null);
        let b2 = (range.startContainer.nextSibling == null);
        let hangOuter = hang.outerHTML.replace("<p class=\"hang\">","").replace("</p>","");
        if ( !hangOuter.includes("</b>") && !hangOuter.includes("</mark>") && !hangOuter.includes("</span>") ) {
            // 表示当前行中没有笔记，既然这样，接下来添加的笔记是第一个，id是无争议的
            // 没有笔记正常流程，不用改动left、right
        } else if ( !b1 && b2 ) {
            let nextId = range.startContainer.previousSibling.id;
            let offR = parseInt(nextId.split("-")[2].split(":")[1]);
            right = right + offR;
            left = right - selection.toString().length;
        } else if ( !b1 ) { // 前无元素后有元素、前后都有元素、前后都无元素
            let preId = range.startContainer.previousSibling.id;
            let offR = parseInt(preId.split("-")[2].split(":")[1]);
            right = right + offR;
            left = right - selection.toString().length;
        }
        let did;
        let hid;
        let duan = selection.focusNode.parentElement.parentElement;
        let duans = document.getElementsByClassName("duan");
        for (let i = 0; i < duans.length; i++) {
            if (duans[i] === duan) {
                did = i;
                let hangs = duans[i].children;
                for (let j = 0; j < hangs.length; j++) {
                    if (hangs[j] === hang) {
                        hid = j;
                    }
                }
            }
        }
        let noteId = did + "-" + hid + "-" + left + ":" + right + "-" + tag + "-" + color;
         */
        console.log("*********noteId:"+noteId)
        // 两种添加ID的情况
        if ( type === 1 ) {
            console.log("进入返回notesId，而不添加notesId，将添加notesId的任务延迟到后边提交按钮处.............")
            return noteId
        } else {
            let basicNote = {
                "notesId": noteId,
                "creatorId": 10001,
                "createTime": new Date
            }
            let sci1 = "onmouseover";
            let sci2 = "onclick";
            let scv1 = "selectNote(this.id,1)";
            let scv2 = "addNote(this.id,this.innerText)";
            let stl = (tag == "mark" ? "background-color" : tag == "b" ? "color":"");
            let node = document.createElement(tag);
            console.log("########noteId:"+noteId)
            node = $(node)
                    .attr("id", noteId)
                    .attr(sci1, scv1)
                    .attr(sci2, scv2)
                    .css(stl, color)
                    .text(selection)[0];
            range.deleteContents();
            range.insertNode(node);
            console.log("原始的添加notesId.............")
            noResponseAjax("addNote", basicNote)
        }
    }
    // 渲染notesID
    const renderNote = function (noteIds) {
        if ( "" != noteIds ) {
            noteIds = noteIds.replace(/\[|]/g, "").split(",");
            for (let n = 0; n < noteIds.length; n++) {
                let did = parseInt(noteIds[n].split("-")[0]);
                let hid = parseInt(noteIds[n].split("-")[1]);
                let left = parseInt(noteIds[n].split("-")[2].split(":")[0]);
                let right = parseInt(noteIds[n].split("-")[2].split(":")[1]);
                let tag = noteIds[n].split("-")[3];
                let color;
                switch (noteIds[n].split("-")[4]) {
                    case "black":
                        color = "black";
                        break;
                    case "red":
                        color = "red";
                        break;
                    case "blue":
                        color = "blue";
                        break;
                    case "green":
                        color = "green";
                        break;
                    case "skyblue":
                        color = "skyblue";
                        break;
                    case "yellowgreen":
                        color = "yellowgreen";
                        break;
                    case "purple":
                        color = "purple";
                        break;
                    case "orange":
                        color = "orange";
                        break;
                    default:
                        color = "";
                        break;
                }
                let sci1 = "onmouseover";
                let sci2 = "onclick";
                let scv1 = "selectNote(this.id,1)";
                let scv2 = "addNote(this.id,this.innerText)";
                let script = " "+sci1+"="+scv1+" "+sci2+"="+scv2
                let stl = (tag == "mark" ? "background-color" : tag == "b" ?  "color":"");
                let thisHangNode = document.getElementsByClassName("duan")[did].getElementsByClassName("hang")[hid];
                let ml = "<"+tag+" id="+noteIds[n]+" style="+stl+":"+color+script+">";
                thisHangNode.innerHTML = replaceSelectionIgnoreMark(thisHangNode,left,right,ml);
            }
        }
    };


    // 当用户点击右键菜单时包装选中的文本
    function getNoteId(selection,tag,color) {
        function innerAddNoteId() {
            return generateNoteId(selection,tag,color,1)
        }
        return  innerAddNoteId;
    }

    $(function(){
        $("p").bind('mouseup',function(){
            let sel = getSel();
            let getId = getNoteId(sel,"tag","color");
            selectionText = sel.toString();
            noteID = getId(); // 为全局变量赋值
        })
    })

    function getSel(){
        if(document.Selection){
            //ie浏览器
            return document.selection;
        }else{
            //标准浏览器
            return window.getSelection();
        }
    }

    // 创建右键菜单类
    (function() {
        let that;
        let arr = new Array();
        let html = "";
        ! function(e) {




            e.RMenu = {
                init: function(per) {
                    if (typeof(per) != "object" && !per.hasOwnProperty('area') && !per.hasOwnProperty(
                        'items') && !per.hasOwnProperty('callback')) throw "json 数据错误";
                    that = this;
                    this.showmenu(per);
                    let areaHeight = $(per.area).height();
                    let areaWidth = $(per.area).width();
                    let menuHeight = $('.RCM-Main').height();
                    let menuWidth = $('.RCM-Main').width();
                    let thisClickId;
                    $(per.area).bind('contextmenu', function() {
                       thisClickId = event.target.id;
                        let xPos = parseInt(event.pageX + 10);
                        let yPos = event.pageY;
                        if (areaWidth - xPos < menuWidth) {
                            xPos = (xPos - menuWidth - 20);
                            $('.RCM-container').css({
                                left: (xPos - menuWidth - 20) + "px",
                                top: yPos + "px"
                            }).show();
                        }
                        if (areaHeight - yPos < menuHeight) {
                            yPos = (yPos - menuHeight - 20);
                        }
                        $('.RCM-Main').css({
                            left: xPos + "px",
                            top: yPos + "px"
                        }).show();
                        return false;
                    })
                    $(per.area).on('click', function() {
                        $('.RCM-container').hide();
                    });

                    $('.RCM-container li').on('click', function() {
                        let content = $(this).data('content');
                        $('.RCM-container').hide();
                            per.callback({
                                event: 'click',
                                data: content,
                                clickId:thisClickId
                            });
                    });

                    $('.RCM-container ul li').mouseover(function(e) {
                        if ($(this).find('i').hasClass('fa-align-right')) {
                            let width = $(this).find('i').next('.RCM-child').width();
                            $(this).find('i').next('.RCM-child').css('left', width).show();
                        }
                    });

                    $('.RCM-container ul li,.RCM-child li').mouseout(function() {
                        $('.RCM-child').hide();
                    });
                },
                contextMenu: function(per, key) {

                        var key = key ? key : "Main";
                        html += '<div class="RCM-container RCM-' + key + '"><ul>';
                        $.each(per.items, function(item, val) {
                            let icon = val.icon ? '<i class="fa fa-' + val.icon + ' fa-fw ">&nbsp;' : ''
                            let center = val.icon ? 'nocenter' : 'textcenter';
                            let iconAfter = val.items ?
                                '<i class="fa fa-chevron-right fa-fw fa-align-right">&nbsp;' : '';
                            html += '<li  data-content=' + item + ' class="' + center +'">' + icon +
                                '</i>' + val.name + iconAfter + '</i>';
                            if (val.hasOwnProperty('items')) {
                                that.contextMenu(val, 'child');
                            }
                            html += '</li>';
                        });
                        html += "</ul></div>";
                        return html;
                },
                showmenu: function(per) {
                    let ce = this.contextMenu(per);
                    $(per.area).append(ce);
                    $('.RCM-container').hide();
                }
            };
        }(window)
    })();

    // 初始化右键菜单
    $(document).ready(function(){
        // 渲染右键菜单
        var rcm = window.RMenu;
        rcm.init({
            area: 'body',
            items: {
                "mark": {
                    name: "标记选中", icon: 'font',
                    items: {
                        "underline": {name: "划线记号", icon: 'underline'},
                        "bold": {name: "加粗记号", icon: 'bold'}
                    }
                },
                "highlight": {
                    name: "高亮选中", icon: 'google-wallet',
                    items: {
                        "high-text": {name: "描边高亮", icon: 'square-o'},
                        "high-bg": {name: "背景高亮", icon: 'square'}
                    }
                },
                "leanpub": {
                    name: "阅读笔记", icon: 'leanpub',
                    items: {
                        "note-text": {name: "文本笔记", icon: 'file-word-o'},
                        "note-pic": {name: "图片笔记", icon: 'file-image-o'},
                        "note-aud": {name: "音频笔记", icon: 'file-sound-o'},
                        "note-vid": {name: "视频笔记", icon: 'file-video-o'}
                    }
                },
                "edit": {name: "编辑笔记", icon: 'edit'},
                "del": {name: "删除笔记", icon: 'trash-o'}
            },
            callback: function (res) {
                let params;
                if (res.data == 'underline') {
                    console.log("点击了划线———————————》noteID:" + noteID)
                    let color = "";
                    let tag = "span";
                    let finalNoteId = noteID.replace("color", color).replace("tag", tag);
                    console.log("finalNoteId:" + finalNoteId)
                    params = {
                        notesId: finalNoteId,
                        creatorId: 10001,
                        createTime: new Date
                    }
                    noResponseAjax("addNote", params)
                    renderNote(finalNoteId);
                } else if (res.data == 'bold') {
                    console.log("点击了加粗———————————》noteID:" + noteID)
                    let color = "black";
                    let tag = "b";
                    let finalNoteId = noteID.replace("color", color).replace("tag", tag);
                    console.log("finalNoteId:" + finalNoteId)
                    params = {
                        notesId: finalNoteId,
                        creatorId: 10001,
                        createTime: new Date
                    }
                    noResponseAjax("addNote", params)
                    renderNote(finalNoteId);
                } else if (res.data == 'high-text') {
                    console.log("点击了描边高亮———————————》noteID:" + noteID)
                    let color = "orange";
                    let tag = "b";
                    let finalNoteId = noteID.replace("color", color).replace("tag", tag);
                    console.log("finalNoteId:" + finalNoteId)
                    params = {
                        notesId: finalNoteId,
                        creatorId: 10001,
                        createTime: new Date
                    }
                    noResponseAjax("addNote", params)
                    renderNote(finalNoteId);
                } else if (res.data == 'high-bg') {
                    console.log("点击了背景高亮———————————》noteID:" + noteID)
                    let color = "orange";
                    let tag = "mark";
                    let finalNoteId = noteID.replace("color", color).replace("tag", tag);
                    console.log("finalNoteId:" + finalNoteId)
                    params = {
                        notesId: finalNoteId,
                        creatorId: 10001,
                        createTime: new Date
                    }
                    noResponseAjax("addNote", params)
                    renderNote(finalNoteId);
                } else if (res.data == 'note-text') {
                    if (undefined != noteID) {
                        let color = "black";
                        let tag = "b";
                        let finalNoteId;
                        let keyword;
                        if (undefined != res.clickId) {
                            finalNoteId = res.clickId;
                            keyword = document.getElementById(finalNoteId).innerText
                        } else {
                            finalNoteId = noteID.replace("color", color).replace("tag", tag);
                            params = {
                                notesId: finalNoteId,
                                creatorId: 10001,
                                createTime: new Date
                            }
                            noResponseAjax("addNote", params)
                            renderNote(finalNoteId)
                            console.log("__________finalNoteId:" + finalNoteId)
                            console.log("__________selectionText:" + selectionText)
                            keyword = selectionText
                        }
                        addNote(finalNoteId, keyword)
                    }


                } else if (res.data == 'note-pic') {
                    console.log('点击了图片笔记');
                } else if (res.data == 'note-aud') {
                    console.log('点击了音频笔记');
                } else if (res.data == 'note-vid') {
                    console.log('点击了视频笔记');
                } else if (res.data == 'edit') {
                    console.log('点击了编辑笔记' + res.clickId);
                    if (undefined != res.clickId) {
                        let noteId = res.clickId
                        let keyword = document.getElementById(noteId).innerText
                        addNote(noteId, keyword)
                    }
                } else if (res.data == 'del') {
                    console.log('点击了删除笔记');
                    delNoteInfo(res.clickId);
                }
            }
        })



    })

    // 当用户右击了body，将右键菜单渲染到dom
    $(function(){
            $("body").bind('mouseup', function () {

            })
    })

    // 在某一事件触发后，刷新事件源的Text节点内容
    function updateContent(target,e){
        $(target).text(e.target.value);
    }
    // 清除添加笔记的提示内容
    function clearAddNoteTip(target){
        if ( $(target).html() == "请输入需要添加的笔记：" ){
            $(target).html("");
        }
    }

    /**
     * @type js data-insert-ajax-tool
     * @desc 操作后端数据的ajax
     * @time 2022/10/21 9:37
     * @author mabo
     * @param serviceName
     * @param params
     */
    function noResponseAjax(serviceName,params){
        $.ajax({
            type: "post",
            url: "http://127.0.0.1:8080/"+serviceName,
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(params)
        });
    }

    /**
     * @type js data-select-ajax-tool
     * @desc 查询后端数据的ajax
     * @time 2022/10/21 9:39
     * @author mabo
     * @param serviceName
     * @param params
     */
    function responseAjax(serviceName,params){
        let rs;
        $.ajax({
            type: "post",
            url: "http://127.0.0.1:8080/"+serviceName,
            contentType: "application/json;charset=UTF-8",
            async: false,
            data: JSON.stringify(params),
            success:function (value) {
                rs =  value; // 默认的异步ajax请求无法对全局变量赋值，需加上async: false
            }
        });
        return rs;
    }
    /**
     * 清除划线或笔记
     */
    function delNoteInfo(nid){
        console.log("***********nid:"+nid)
        if (undefined != nid){
            let params = {
                notesId:nid,
                clearType:1  // 1.清除划线 2.清除划线和笔记
            }

            let response = responseAjax("clearNote",params);
            if ( response.includes("存在笔记") ){
                swal({
                        title:"操作反馈",
                        text:response,
                        showCancelButton: true,
                        cancelButtonText: "取消删除",
                        confirmButtonText: "确定删除",
                        confirmButtonColor: "#DEB887"
                    },function(isConfirm) {
                        if (isConfirm) {
                            params.clearType = 2;
                            responseAjax("clearNote",params);
                            let mark = document.getElementById(nid).outerHTML.split(" ")[0].split("<")[1];
                            let parent = document.getElementById(nid).parentElement;
                            let rs = clearMark(parent.innerHTML,mark,nid);
                            parent.innerHTML = rs;
                        } else {
                            swal("取消删除笔记")
                            noResponseAjax("toReader","")
                        }
                    }
                )
            } else {
                let mark = document.getElementById(nid).outerHTML.split(" ")[0].split("<")[1];
                let parent = document.getElementById(nid).parentElement;
                let rs = clearMark(parent.innerHTML,mark,nid);
                parent.innerHTML = rs;
                swal("笔记删除成功")
            }
        }
        /*
        swal("是否清除笔记？", {
            buttons: {
                cancel: "取消操作！",
                catch: {
                    text: "清除划线！",
                    value: "clear_stl",
                },
                default: {
                    text: "清除划线和笔记！",
                    value: "clear_all",
                }
            },
        }).then((value) => {
                switch (value) {
                    case "clear_stl":
                        params.clearType = 1;
                        let clearResultInfo = responseAjax("clearNote",params)
                        swal(clearResultInfo+"！"); // 划线已经清除
                        break;
                    case "clear_all":
                        params.clearType = 2;
                        clearResultInfo = responseAjax("clearNote",params)
                        swal(clearResultInfo+"！"); // 划线和笔记已清除
                        break;
                }
            });
            *
         */
        noResponseAjax("toReader","");
    }

    /**
     * 添加笔记
     */
    function addNote(noteId,keyword) {
        // if ( undefined != target ) {
            swal({
                    title:"处理有关<font color='#d2691e'>"+keyword+"</font>的笔记：",
                    text:"<textarea id='note' onfocus='clearAddNoteTip(this)' onblur='updateContent(this,event)'>"+selectNote(noteId,2)+"</textarea>",
                    html:true,
                    type: "info",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "确定处理",
                    cancelButtonText: "取消处理",
                    closeOnConfirm: false,
                    closeOnCancel: false
                },function(isConfirm){
                    if (isConfirm) {
                        // 添加笔记到后端
                        let params = {
                            notesId:noteId,
                            noteContent:$("#note").text(),
                            creatorId:10001,
                            createTime:new Date
                        }
                        let response = responseAjax("addNote",params);
                        swal({
                            title: "处理结果",
                            text: response
                        });
                    } else {
                        swal("取消", "处理笔记操作已取消","error");
                    }
                }
             )
        // }
    }
    /**
     * 查询笔记
     */
    function selectNote(noteId,v) {
        let note;
        let response;
        $.ajax({
            type: "post",
            url: "http://127.0.0.1:8080/selectNote",
            contentType: "application/json;charset=UTF-8",
            async: false,
            data: JSON.stringify({"notesId":noteId}),
            success:function (value) {
                response =  value; // 默认的异步ajax请求无法对全局变量赋值，需加上async: false
            }
        });
        if ( v == 2 ) {
            if ( response != "null" && response != "" ){
                note = response;
            } else {
                note = "请输入需要添加的笔记：";
            }
            let noteDom = document.getElementById("note");
            $(noteDom).innerText = note;
        }
        else if (  v == 1 && response != "null"  && response != "" ) {
            document.getElementById(noteId).setAttribute("title", response);
        }
        return note;
    }

    /**
     * @type insert
     * @desc 添加笔记id v0.1
     * @time 2022/10/24 22:21
     * @author mabo
     * @param color
     * @param tag

     function addNoteId(selection,color,tag) {
         if ( undefined == selection || null == selection){
         selection = window.getSelection();
        }
        let hang = selection.focusNode.parentElement;
        let range = selection.getRangeAt(0);
        let left = selection.anchorOffset;
        let right = selection.focusOffset;
        if ( left == right ) {
            return false;
        }
        let max;
        if ( left > right ) {
            max = left;
            left = right;
            right = max;
        }
        let b1 = (range.startContainer.previousSibling == null);
        let b2 = (range.startContainer.nextSibling == null);
        let hangOuter = hang.outerHTML.replace("<p class=\"hang\">","").replace("</p>","");
        if ( !hangOuter.includes("</b>") && !hangOuter.includes("</mark>") ) {
            // 表示当前行中没有笔记，既然这样，接下来添加的笔记是第一个，id是无争议的
            // 没有笔记正常流程，不用改动left、right
        } else if ( !b1 && b2 ) {
            let nextId = range.startContainer.previousSibling.id;
            let offR = parseInt(nextId.split("-")[2].split(":")[1]);
            right = right + offR;
            left = right - selection.toString().length;
        } else if ( !b1 ) { // 前无元素后有元素、前后都有元素、前后都无元素
            let preId = range.startContainer.previousSibling.id;
            let offR = parseInt(preId.split("-")[2].split(":")[1]);
            right = right + offR;
            left = right - selection.toString().length;
        }
        let did;
        let hid;
        let duan = selection.focusNode.parentElement.parentElement;
        let duans = document.getElementsByClassName("duan");
        for (let i = 0; i < duans.length; i++) {
            if (duans[i] === duan) {
                did = i;
                let hangs = duans[i].children;
                for (let j = 0; j < hangs.length; j++) {
                    if (hangs[j] === hang) {
                        hid = j;
                    }
                }
            }
        }
        let noteId = did + "-" + hid + "-" + left + ":" + right + "-" + tag + "-" + color;
        let basicNote = {
            "notesId": noteId,
            "creatorId": 10001,
            "createTime": new Date
        }
        let sci1 = "onmouseover";
        let sci2 = "onclick";
        let scv1 = "selectNote(this,1)";
        let scv2 = "addNote(this,2)";

        let stl = tag == "mark" ? "background-color" : "color";
        let node = document.createElement(tag);
        node = $(node).attr("id", noteId).attr(sci1, scv1).attr(sci2, scv2).css(stl, color).text(selection)[0];
        range.deleteContents();
        range.insertNode(node);
        noResponseAjax("addNote", basicNote)
    }
     */

    // 初始化
    $(document).ready(function(){
        // 具体操作
        renderNote(responseAjax("selectNotesIds",""));
    })


</script>

</body>
</html>
